<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 이미지 스튜디오</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>
<body>

<div class="container">
    <h1>🎨 AI 이미지 변환/생성 스튜디오</h1>

    <div class="mode-selector">
        <button class="btn mode-btn" data-mode="image">📷 이미지 변환</button>
        <button class="btn mode-btn" data-mode="text">📝 텍스트 생성</button>
        <button class="btn mode-btn" data-mode="qr">📱 QR 코드 스캔/업로드</button>
    </div>

    <section id="qrMode" class="section-box mode-content" style="display: none;">
        <h3>📱 QR 코드 스캔 및 처리</h3>
        <div id="qr-reader" style="width: 100%;"></div>
        <p id="qrResultStatus" class="status-text"></p>
        <p class="status-text note">QR 스캔은 카메라 접근 권한이 필요하며, 보안상의 이유로 HTTPS 환경에서만 작동할 수 있습니다.</p>
    </section>

    <section id="imageMode" class="section-box mode-content" style="display: none;">
    </section>

    <section id="textMode" class="section-box mode-content" style="display: none;">
    </section>

    <section id="commonAISettings" class="section-box" style="display: none;">
    </section>

</div>

<script>
    // 전역 변수 설정
    let currentMode = 'image';
    let uploadedFile = null;
    let html5QrCode = null; // QR 스캐너 객체

    document.addEventListener('DOMContentLoaded', () => {
        // ... (요소 변수 선언 생략)

        // 모드 전환 로직
        document.querySelectorAll('.mode-btn').forEach(button => {
            button.addEventListener('click', () => {
                const prevMode = currentMode;
                currentMode = button.dataset.mode;

                document.querySelectorAll('.mode-content').forEach(content => {
                    content.style.display = 'none';
                });
                document.getElementById(currentMode + 'Mode').style.display = 'block';
                document.getElementById('commonAISettings').style.display = 'block';
                document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                button.classList.add('active');

                // [수정] QR 모드 진입/이탈 시 카메라 제어
                if (prevMode === 'qr' && html5QrCode) {
                    // 다른 모드로 전환 시 스캐너 중지
                    html5QrCode.stop().then(ignore => {
                        console.log("QR scanning stopped.");
                    }).catch(err => {
                        console.log("Error stopping QR scanning:", err);
                    });
                }
                if (currentMode === 'qr') {
                    // QR 모드 진입 시 스캐너 시작
                    initializeQrScanner();
                }
            });
        });

        // ... (파일 업로드 로직은 동일) ...

        // [추가] QR 스캐너 초기화 함수
        function initializeQrScanner() {
            if (!html5QrCode) {
                html5QrCode = new Html5Qrcode("qr-reader");
            }

            // 스캐너 설정
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };

            // 스캐너 시작
            html5QrCode.start(
                { facingMode: "environment" }, // 후면 카메라 사용
                config,
                (decodedText, decodedResult) => {
                    // QR 코드 스캔 성공!
                    document.getElementById('qrResultStatus').textContent = `스캔 성공: ${decodedText.substring(0, 30)}...`;

                    // 스캔된 텍스트를 Text-to-Image 모드의 프롬프트로 자동 입력
                    document.getElementById('textPromptInput').value = decodedText;

                    // [자동 전환] 텍스트가 스캔되었으므로 Text 모드로 자동 전환하여 AI 설정 진행
                    document.querySelector('.mode-btn[data-mode="text"]').click();
                    alert(`QR 코드 스캔 성공! 텍스트가 AI 프롬프트에 자동 입력되었습니다.`);

                    html5QrCode.stop(); // 스캔 성공 후 카메라 중지
                },
                (errorMessage) => {
                    // 스캔 진행 중 (오류 메시지는 무시)
                    document.getElementById('qrResultStatus').textContent = "QR 코드를 중앙에 맞춰주세요.";
                }
            ).catch((err) => {
                document.getElementById('qrResultStatus').textContent = `카메라 접근 오류 또는 지원되지 않는 환경: ${err}`;
                console.error("QR Scanner Start Error:", err);
            });
        }

        // 초기 모드 설정
        document.querySelector('.mode-btn[data-mode="image"]').click();

        // ... (AI 변환 버튼 클릭 시 로직은 이전 코드와 동일) ...
    });
</script>
</body>
</html>