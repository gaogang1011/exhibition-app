<!DOCTYPE html>
<html lang="ko">
<head>
    <title>AI Studio</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<div id="fullScreenLoading" class="full-screen-loading" style="display: none;">
    <img src="brush_loading_bw.gif" alt="Processing..." class="loading-gif-full">
    <p class="loading-text-full">PROCESSING...</p>
</div>

<script>
    // ... (기존 변수 및 모드 전환, 업로드, QR 로직) ...

    // ⭐️ [새로운 전역 변수]
    let aiProcessingPromise = null; // AI 처리 비동기 작업을 저장할 Promise
    const GIF_WHITE_FRAME_TIME_MS = 1500; // GIF가 하얀색 배경으로 전환되는 시간 (예시: 1.5초)

    // --- AI 변환 버튼 클릭 시 로직 수정 ---
    document.getElementById('aiConvertButton').addEventListener('click', async () => {
        // ... (기존 프롬프트 및 안전 필터링 로직) ...

        // ... (기존 FormData 구성 로직) ...

        fullScreenLoading.style.display = 'flex'; // 전체 화면 로딩 표시
        // ⭐️ [추가] GIF의 배경색을 관리하기 위한 CSS 변수 설정
        document.documentElement.style.setProperty('--loading-bg-color', 'rgba(0, 0, 0, 0.95)');

        try {
            // ⭐️ [수정] AI 처리 요청을 Promise로 래핑
            aiProcessingPromise = fetch('/api/ai-process', { method: 'POST', body: formData })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(errorData => {
                            throw new Error(errorData.error || 'Generation failed (Server Error)');
                        });
                    }
                    return response.json();
                });

            // ⭐️ [추가] AI 응답 대기 및 GIF 타이밍 맞추기
            const [aiData] = await Promise.all([
                aiProcessingPromise,
                new Promise(resolve => setTimeout(resolve, GIF_WHITE_FRAME_TIME_MS))
            ]);

            // ⭐️ [추가] AI 응답이 도착했고 GIF가 흰색이 되는 시점까지 대기 완료
            // 이제 배경색을 흰색으로 변경하고 리디렉션
            document.documentElement.style.setProperty('--loading-bg-color', 'white'); // 배경을 흰색으로
            document.getElementById('fullScreenLoading').style.backgroundColor = 'white'; // 실제 오버레이도 흰색으로
            document.querySelector('.loading-text-full').style.color = 'black'; // 텍스트 색상도 검은색으로

            // 잠시 대기하여 흰색 배경이 보일 시간을 줌 (예: 100ms)
            await new Promise(resolve => setTimeout(resolve, 100));

            if (aiData.filename) {
                let redirectUrl = `download.html?file=${aiData.filename}&mode=${aiData.mode}`;
                if (aiData.visionDescription) {
                    redirectUrl += `&desc=${encodeURIComponent(aiData.visionDescription)}`;
                }
                window.location.href = redirectUrl;
            } else {
                alert('Result URL not received.');
                fullScreenLoading.style.display = 'none';
                // ⭐️ [추가] 오류 발생 시 배경색 초기화
                document.documentElement.style.setProperty('--loading-bg-color', 'rgba(0, 0, 0, 0.95)');
                document.getElementById('fullScreenLoading').style.backgroundColor = 'rgba(0, 0, 0, 0.95)';
                document.querySelector('.loading-text-full').style.color = 'white';
            }
        } catch(e) {
            alert(`Error: ${e.message || 'Network error or processing error.'}`);
            console.error("Fetch/System Error:", e);
            fullScreenLoading.style.display = 'none';
            // ⭐️ [추가] 오류 발생 시 배경색 초기화
            document.documentElement.style.setProperty('--loading-bg-color', 'rgba(0, 0, 0, 0.95)');
            document.getElementById('fullScreenLoading').style.backgroundColor = 'rgba(0, 0, 0, 0.95)';
            document.querySelector('.loading-text-full').style.color = 'white';
        }
    });

    document.querySelector('.mode-btn[data-mode="image"]').click();
</script>
</body>
</html>