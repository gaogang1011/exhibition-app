<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ì´ë¯¸ì§€ ìŠ¤íŠœë””ì˜¤</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="container">
    <h1>ğŸ¨ AI ì´ë¯¸ì§€ ë³€í™˜/ìƒì„± ìŠ¤íŠœë””ì˜¤</h1>

    <div class="mode-selector">
        <button class="btn mode-btn" data-mode="image">ğŸ“· ì´ë¯¸ì§€ ë³€í™˜ (Image to Image)</button>
        <button class="btn mode-btn" data-mode="text">ğŸ“ í…ìŠ¤íŠ¸ ìƒì„± (Text to Image)</button>
        <button class="btn mode-btn" data-mode="qr">ğŸ“± QR ì½”ë“œ ìŠ¤ìº”/ì—…ë¡œë“œ</button>
    </div>

    <section id="imageMode" class="section-box mode-content" style="display: none;">
        <h3>ğŸ“· ì´ë¯¸ì§€ ì—…ë¡œë“œ ë° ë³€í™˜</h3>
        <input type="file" accept="image/*" id="fileUploader" style="display: none;">
        <button id="uploadButton" class="btn primary-btn">íŒŒì¼ ì„ íƒ (ì•¨ë²”/íŒŒì¼ ì ‘ê·¼ ê°€ëŠ¥)</button>
        <img id="originalImage" alt="ì—…ë¡œë“œëœ ì›ë³¸ ì´ë¯¸ì§€" class="preview-img" style="display: none;">
        <p id="fileStatus" class="status-text"></p>
    </section>

    <section id="textMode" class="section-box mode-content" style="display: none;">
        <h3>ğŸ“ í…ìŠ¤íŠ¸ë¡œ ì´ë¯¸ì§€ ìƒì„±</h3>
        <textarea id="textPromptInput" placeholder="ìƒì„±í•˜ê³  ì‹¶ì€ ì´ë¯¸ì§€ë¥¼ ìƒì„¸íˆ ì„¤ëª…í•˜ì„¸ìš”..."
                  rows="3" class="input-full"></textarea>
        <p class="status-text">ìŠ¤íƒ€ì¼ì€ ì•„ë˜ ê³µí†µ ì„¤ì •ì„ ë”°ë¦…ë‹ˆë‹¤.</p>
    </section>

    <section id="qrMode" class="section-box mode-content" style="display: none;">
        <h3>ğŸ“± QR ì½”ë“œ ìŠ¤ìº” (ê¸°ëŠ¥ ì—°ë™ í•„ìš”)</h3>
        <p class="status-text">QR ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ì—¬ ë°”ë¡œ ì´ë¯¸ì§€/í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        <button class="btn primary-btn">QR ì½”ë“œ ìŠ¤ìº” ì‹œì‘</button>
    </section>

    <section id="commonAISettings" class="section-box" style="display: none;">
        <h3>ê³µí†µ AI ì„¤ì •</h3>
        <textarea id="stylePromptInput" placeholder="AI ìŠ¤íƒ€ì¼ ì¶”ê°€ ì„¤ëª…..." rows="2" class="input-full"></textarea>
        <select id="styleSelect" class="input-full">
            <option value="default">ìŠ¤íƒ€ì¼ ì„ íƒ (ì„ íƒ ì‚¬í•­)</option>
            <option value="cartoon">ì¹´íˆ° ìŠ¤íƒ€ì¼</option>
            <option value="oilpainting">ìœ í™” ìŠ¤íƒ€ì¼</option>
        </select>

        <button id="aiConvertButton" class="btn secondary-btn">âœ¨ AIë¡œ ë³€í™˜/ìƒì„±í•˜ê¸°</button>

        <p id="loadingStatus" class="status-text" style="display: none;">AI ì´ë¯¸ì§€ ìƒì„± ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</p>
    </section>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // ... (ìš”ì†Œ ë³€ìˆ˜ ì„ ì–¸ ìƒëµ)
        let currentMode = 'image'; // í˜„ì¬ ëª¨ë“œ
        let uploadedFile = null;

        // ëª¨ë“œ ì „í™˜ ë¡œì§
        document.querySelectorAll('.mode-btn').forEach(button => {
            button.addEventListener('click', () => {
                currentMode = button.dataset.mode;
                document.querySelectorAll('.mode-content').forEach(content => {
                    content.style.display = 'none';
                });
                document.getElementById(currentMode + 'Mode').style.display = 'block';
                document.getElementById('commonAISettings').style.display = 'block';
                document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                button.classList.add('active');
            });
        });

        // ì´ˆê¸° ëª¨ë“œ ì„¤ì •
        document.querySelector('.mode-btn[data-mode="image"]').click();

        // íŒŒì¼ ì—…ë¡œë“œ ë¡œì§ (ì´ì „ ì½”ë“œì™€ ë™ì¼)
        document.getElementById('uploadButton').addEventListener('click', () => {
            document.getElementById('fileUploader').click();
        });
        document.getElementById('fileUploader').addEventListener('change', (event) => {
            uploadedFile = event.target.files[0];
            if (!uploadedFile) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('originalImage').src = e.target.result;
                document.getElementById('originalImage').style.display = 'block';
                document.getElementById('fileStatus').textContent = `ì„ íƒëœ íŒŒì¼: ${uploadedFile.name}`;
            };
            reader.readAsDataURL(uploadedFile);
        });

        // AI ë³€í™˜ ë²„íŠ¼ í´ë¦­ ì‹œ (í†µí•© ë¡œì§)
        document.getElementById('aiConvertButton').addEventListener('click', async () => {
            let prompt = '';
            const style = document.getElementById('styleSelect').value;
            const stylePrompt = document.getElementById('stylePromptInput').value;

            // 1. ëª¨ë“œë³„ ìœ íš¨ì„± ê²€ì‚¬ ë° í”„ë¡¬í”„íŠ¸ ì„¤ì •
            if (currentMode === 'image') {
                if (!uploadedFile) return alert('ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
                prompt = 'ì´ë¯¸ì§€ë¥¼ AI ìŠ¤íƒ€ì¼ë¡œ ë³€í™˜: ' + stylePrompt; // Image to Image
            } else if (currentMode === 'text') {
                prompt = document.getElementById('textPromptInput').value;
                if (!prompt) return alert('ìƒì„±í•  í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                prompt += (stylePrompt ? ', ' + stylePrompt : ''); // Text to Image
            } else if (currentMode === 'qr') {
                // QR ì½”ë“œë¡œ íšë“í•œ ì´ë¯¸ì§€ë¥¼ uploadedFileì— í• ë‹¹í•˜ê±°ë‚˜, í…ìŠ¤íŠ¸ë¥¼ promptì— í• ë‹¹í•˜ëŠ” ë¡œì§ í•„ìš”
                alert('QR ì½”ë“œ ìŠ¤ìº” í›„, ì´ë¯¸ì§€ ë˜ëŠ” í…ìŠ¤íŠ¸ ë°ì´í„°ë¥¼ ë¨¼ì € ì„¤ì •í•´ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }

            // ê³µí†µ ì²˜ë¦¬ ì‹œì‘
            document.getElementById('loadingStatus').style.display = 'block';
            document.getElementById('aiConvertButton').disabled = true;

            const formData = new FormData();
            if (uploadedFile && currentMode === 'image') {
                formData.append('image', uploadedFile);
            }
            formData.append('prompt', prompt);
            formData.append('style', style);
            formData.append('mode', currentMode); // ë°±ì—”ë“œì—ì„œ ì–´ë–¤ ëª¨ë“œì¸ì§€ í™•ì¸ìš©

            try {
                const response = await fetch('/api/ai-process', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`AI ì„œë²„ ì˜¤ë¥˜: ${response.statusText}`);
                }

                const data = await response.json();
                const aiImageUrl = data.aiImageUrl;

                if (aiImageUrl) {
                    // ë‹¤ìš´ë¡œë“œ í˜ì´ì§€ë¡œ ì´ë™ ë° ê²°ê³¼ URL ì „ë‹¬
                    window.location.href = `download.html?url=${encodeURIComponent(aiImageUrl)}`;
                } else {
                    alert('AI ë³€í™˜ ê²°ê³¼ URLì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                }

            } catch (error) {
                alert('ì´ë¯¸ì§€ ë³€í™˜ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ì„œë²„/AI í†µì‹  ì˜¤ë¥˜)');
                console.error('Fetch Error:', error);
            } finally {
                document.getElementById('loadingStatus').style.display = 'none';
                document.getElementById('aiConvertButton').disabled = false;
            }
        });
    });
</script>
</body>
</html>