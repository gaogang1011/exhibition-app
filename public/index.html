<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ì´ë¯¸ì§€ ìŠ¤íŠœë””ì˜¤</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
<div class="container">
    <h1>ğŸ¨ AI ì´ë¯¸ì§€ ë³€í™˜/ìƒì„± ìŠ¤íŠœë””ì˜¤</h1>

    <div class="mode-selector">
        <button class="btn mode-btn active" data-mode="image">ğŸ“· ì´ë¯¸ì§€ ë³€í™˜ (PC)</button>
        <button class="btn mode-btn" data-mode="text">ğŸ“ í…ìŠ¤íŠ¸ ìƒì„±</button>
        <button class="btn mode-btn" data-mode="qr">ğŸ“± QR ì—…ë¡œë“œ (Mobile)</button>
    </div>

    <section id="imageMode" class="section-box mode-content">
        <h3>ğŸ“· ë‚´ PC íŒŒì¼ë¡œ ë³€í™˜</h3>
        <input type="file" accept="image/*" name="pcImage" id="fileUploader" style="display: none;">
        <button id="uploadButton" class="btn primary-btn">PC íŒŒì¼ ì„ íƒ</button>
        <img id="originalImage" alt="ì—…ë¡œë“œëœ ì›ë³¸ ì´ë¯¸ì§€" class="preview-img" style="display: none;">
        <p id="fileStatus" class="status-text"></p>
    </section>

    <section id="textMode" class="section-box mode-content" style="display: none;">
        <h3>ğŸ“ í…ìŠ¤íŠ¸ë¡œ ì´ë¯¸ì§€ ìƒì„±</h3>
        <textarea id="textPromptInput" placeholder="ìƒì„±í•˜ê³  ì‹¶ì€ ì´ë¯¸ì§€ë¥¼ ìƒì„¸íˆ ì„¤ëª…í•˜ì„¸ìš”..." rows="3" class="input-full"></textarea>
    </section>

    <section id="qrMode" class="section-box mode-content" style="display: none;">
        <h3>ğŸ“± ëª¨ë°”ì¼ ì‚¬ì§„ ì „ì†¡ (QR ë¸Œë¦¬ì§€)</h3>

        <button id="qrUploadStartButton" class="btn primary-btn">QR ì½”ë“œ ìƒì„± ì‹œì‘</button>

        <div id="qrBridgeArea" style="display: none; text-align: center;">
            <h4>ëª¨ë°”ì¼ ì—…ë¡œë“œ ëŒ€ê¸° ì¤‘...</h4>
            <div id="qrcode" class="qr-box"></div>
            <p id="qrBridgeStatus" class="status-text note">ëª¨ë°”ì¼ë¡œ ìœ„ QR ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ì—¬ ì‚¬ì§„ì„ ì „ì†¡í•˜ì„¸ìš”.</p>
            <button id="cancelQrButton" class="btn secondary-btn">ì·¨ì†Œ</button>
        </div>

        <img id="qrOriginalImage" alt="QRë¡œ ì—…ë¡œë“œëœ ì´ë¯¸ì§€" class="preview-img" style="display: none;">
        <p id="qrFileStatus" class="status-text"></p>
    </section>

    <section id="commonAISettings" class="section-box">
        <h3>ê³µí†µ AI ì„¤ì •</h3>
        <textarea id="stylePromptInput" placeholder="AI ìŠ¤íƒ€ì¼ ì¶”ê°€ ì„¤ëª…..." rows="2" class="input-full"></textarea>
        <select id="styleSelect" class="input-full">
            <option value="default">ìŠ¤íƒ€ì¼ ì„ íƒ (ì„ íƒ ì‚¬í•­)</option>
            <option value="cartoon">ì¹´íˆ° ìŠ¤íƒ€ì¼</option>
            <option value="oilpainting">ìœ í™” ìŠ¤íƒ€ì¼</option>
        </select>

        <button id="aiConvertButton" class="btn secondary-btn">âœ¨ AIë¡œ ë³€í™˜/ìƒì„±í•˜ê¸°</button>

        <p id="loadingStatus" class="status-text" style="display: none;">AI ì´ë¯¸ì§€ ìƒì„± ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</p>
    </section>
</div>

<script>
    let currentMode = 'image';
    let pcUploadedFile = null;
    let qrUploadedFileName = null;
    let currentSessionId = null;
    let pollingInterval = null;

    const fileUploader = document.getElementById('fileUploader');
    const uploadButton = document.getElementById('uploadButton');
    const originalImage = document.getElementById('originalImage');
    const fileStatus = document.getElementById('fileStatus');
    const qrUploadStartButton = document.getElementById('qrUploadStartButton');
    const qrBridgeArea = document.getElementById('qrBridgeArea');
    const qrcodeDiv = document.getElementById('qrcode');
    const qrBridgeStatus = document.getElementById('qrBridgeStatus');
    const cancelQrButton = document.getElementById('cancelQrButton');
    const qrOriginalImage = document.getElementById('qrOriginalImage');
    const qrFileStatus = document.getElementById('qrFileStatus');

    // --- ëª¨ë“œ ì „í™˜ ë¡œì§ ---
    document.querySelectorAll('.mode-btn').forEach(button => {
        button.addEventListener('click', () => {
            currentMode = button.dataset.mode;
            document.querySelectorAll('.mode-content').forEach(content => content.style.display = 'none');
            document.getElementById(currentMode + 'Mode').style.display = 'block';
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            button.classList.add('active');

            // ëª¨ë“œ ì „í™˜ ì‹œ ì´ì „ QR í´ë§ ì¤‘ì§€
            if (pollingInterval) clearInterval(pollingInterval);
            qrBridgeArea.style.display = 'none';
            qrUploadStartButton.style.display = 'inline-block';
        });
    });

    // --- 1. PC ì—…ë¡œë“œ ë¡œì§ ---
    uploadButton.addEventListener('click', () => fileUploader.click());
    fileUploader.addEventListener('change', (event) => {
        pcUploadedFile = event.target.files[0];
        qrUploadedFileName = null; // ë‹¤ë¥¸ ì—…ë¡œë“œ ëª¨ë“œ ì´ˆê¸°í™”

        const reader = new FileReader();
        reader.onload = (e) => {
            originalImage.src = e.target.result;
            originalImage.style.display = 'block';
            fileStatus.textContent = `ì„ íƒëœ íŒŒì¼: ${pcUploadedFile.name}`;
            qrOriginalImage.style.display = 'none';
        };
        reader.readAsDataURL(pcUploadedFile);
    });

    // --- 3. QR ì—…ë¡œë“œ ë¡œì§ ---
    qrUploadStartButton.addEventListener('click', startQrUploadSession);
    cancelQrButton.addEventListener('click', cancelQrUploadSession);

    async function startQrUploadSession() {
        const response = await fetch('/api/start-upload-session');
        const data = await response.json();
        currentSessionId = data.sessionId;
        const baseUrl = data.origin;

        if (!currentSessionId) return alert('ì„¸ì…˜ì„ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');

        // UI ì—…ë°ì´íŠ¸
        qrBridgeArea.style.display = 'block';
        qrUploadStartButton.style.display = 'none';

        // QR ì½”ë“œ ìƒì„± (upload.html íŒŒì¼ê³¼ ì„¸ì…˜ IDë¥¼ í¬í•¨)
        const mobileUploadUrl = `${baseUrl}/upload.html?id=${currentSessionId}`;
        qrcodeDiv.innerHTML = '';
        new QRCode(qrcodeDiv, { text: mobileUploadUrl, width: 150, height: 150 });
        qrBridgeStatus.textContent = "ëª¨ë°”ì¼ë¡œ QR ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ì„¸ìš”.";

        // í´ë§ ì‹œì‘
        pollingInterval = setInterval(checkUploadStatus, 1000);
    }

    async function checkUploadStatus() {
        if (!currentSessionId) return;

        const response = await fetch(`/api/check-upload-status/${currentSessionId}`);
        const data = await response.json();

        if (data.status === 'uploaded') {
            clearInterval(pollingInterval);
            currentSessionId = null;

            qrUploadedFileName = data.fileInfo.fileName;
            pcUploadedFile = null;

            // QR ì—…ë¡œë“œëœ ì´ë¯¸ì§€ í‘œì‹œ (ì„œë²„ì—ì„œ íŒŒì¼ ê²½ë¡œ ì§ì ‘ ë¡œë“œ)
            qrOriginalImage.src = `/images/uploads/${qrUploadedFileName}`;
            qrOriginalImage.style.display = 'block';
            qrFileStatus.textContent = `ì—…ë¡œë“œ ì™„ë£Œ: ${data.fileInfo.originalName}`;

            qrBridgeArea.style.display = 'none';
            qrUploadStartButton.style.display = 'inline-block';
            alert('ëª¨ë°”ì¼ íŒŒì¼ ì—…ë¡œë“œ ì™„ë£Œ! AI ë³€í™˜ì„ ì‹œì‘í•´ì£¼ì„¸ìš”.');
        }
    }

    function cancelQrUploadSession() {
        if (pollingInterval) clearInterval(pollingInterval);
        currentSessionId = null;
        qrBridgeArea.style.display = 'none';
        qrUploadStartButton.style.display = 'inline-block';
    }

    // --- AI ë³€í™˜ ë²„íŠ¼ í´ë¦­ ì‹œ (í†µí•© ë¡œì§) ---
    document.getElementById('aiConvertButton').addEventListener('click', async () => {
        let prompt = document.getElementById('textPromptInput').value; // Text Mode í”„ë¡¬í”„íŠ¸
        const style = document.getElementById('styleSelect').value;
        const stylePrompt = document.getElementById('stylePromptInput').value;

        const formData = new FormData();
        formData.append('prompt', prompt + (stylePrompt ? ', ' + stylePrompt : ''));
        formData.append('style', style);
        formData.append('mode', currentMode);

        // ì…ë ¥ ë°ì´í„° ê²€ì¦ ë° FormData ì„¤ì •
        if (currentMode === 'image' && pcUploadedFile) {
            formData.append('pcImage', pcUploadedFile);
        } else if (currentMode === 'qr' && qrUploadedFileName) {
            formData.append('qrUploadedFileName', qrUploadedFileName);
        } else if (currentMode === 'text' && prompt) {
            // Text to Image: íŒŒì¼ í•„ìš” ì—†ìŒ
        } else {
            return alert(`[${currentMode} ëª¨ë“œ]ì— í•„ìš”í•œ ì…ë ¥ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.`);
        }

        // ... (ë¡œë”© ìƒíƒœ í‘œì‹œ ë° fetch í˜¸ì¶œ ë¡œì§ ìœ ì§€) ...
        try {
            const response = await fetch('/api/ai-process', { method: 'POST', body: formData });
            const data = await response.json();

            if (data.aiImageUrl) {
                window.location.href = `download.html?url=${encodeURIComponent(data.aiImageUrl)}`;
            } else {
                alert('AI ë³€í™˜ ê²°ê³¼ URLì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
            }
        } catch(e) { /* ... */ }
    });

    // ì´ˆê¸° ëª¨ë“œ í™œì„±í™” (PC ì´ë¯¸ì§€ ë³€í™˜)
    document.querySelector('.mode-btn[data-mode="image"]').click();
</script>
</body>
</html>